name: Build and Release RDP-Cat Debian Package

on:
  push:
    branches:
      - main
    paths:
      - 'deb_version'
      - 'pkg/**'
      - '.github/workflows/build_and_release.yaml'
  workflow_dispatch:

jobs:
  check_release:
    runs-on: ubuntu-latest
    outputs:
      release_exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read package version
        id: version
        run: |
          source deb_version
          echo "deb_version=${DEB}" >> $GITHUB_OUTPUT
          echo "bin_version=${BIN}" >> $GITHUB_OUTPUT
          echo "Package version: ${DEB}"
          echo "Binary version: ${BIN}"

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view v${{ steps.version.outputs.deb_version }} &>/dev/null; then
            echo "Release v${{ steps.version.outputs.deb_version }} already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release v${{ steps.version.outputs.deb_version }} does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check_release
    if: needs.check_release.outputs.release_exists == 'false'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read package version
        id: version
        run: |
          source deb_version
          echo "deb_version=${DEB}" >> $GITHUB_OUTPUT
          echo "bin_version=${BIN}" >> $GITHUB_OUTPUT
          echo "Package version: ${DEB}"
          echo "Binary version: ${BIN}"

      - name: Update control file version
        env:
          DEB_VERSION: ${{ steps.version.outputs.deb_version }}
        run: |
          sed -i "s/^Version: .*/Version: ${DEB_VERSION}/" pkg/DEBIAN/control
          echo "Control file version updated to: ${DEB_VERSION}"
          grep "^Version:" pkg/DEBIAN/control

      - name: Download RDP-Cat binary
        env:
          ARCH: ${{ matrix.arch }}
          RDP_CAT_VERSION: ${{ steps.version.outputs.bin_version }}
          GH_TOKEN: ${{ secrets.DEB_BUILDER_PAT }}
        run: |
          # Ensure token is present
          if [ -z "${GH_TOKEN}" ]; then
            echo "Error: DEB_BUILDER_PAT not set"
            exit 1
          fi

          echo "Listing release tags (first 5):"
          curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/a2hop/rdp-cat/releases | \
            jq -r '.[].tag_name' | head -5 || echo "(release list unavailable)"
          echo "Target binary version: ${RDP_CAT_VERSION}"

          # Map architecture to candidate asset names
          case "$ARCH" in
            amd64)   CANDIDATES="rdp-cat rdp-cat-amd64" ;;
            arm64)   CANDIDATES="rdp-cat-arm64 rdp-cat" ;;
            armv7)   CANDIDATES="rdp-cat-armv7 rdp-cat-arm rdp-cat" ;;
            *) echo "Unknown arch $ARCH"; exit 1 ;;
          esac

          # Fetch release JSON (try without and with v prefix)
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/a2hop/rdp-cat/releases/tags/${RDP_CAT_VERSION})
          
          if echo "$RELEASE_JSON" | jq -e .id >/dev/null 2>&1; then
            echo "Found release tag ${RDP_CAT_VERSION}"
          else
            echo "Tag ${RDP_CAT_VERSION} not found, trying v${RDP_CAT_VERSION}"
            RELEASE_JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
              https://api.github.com/repos/a2hop/rdp-cat/releases/tags/v${RDP_CAT_VERSION})
          fi

          if ! echo "$RELEASE_JSON" | jq -e .id >/dev/null 2>&1; then
            echo "Error: release not found for ${RDP_CAT_VERSION} (with or without v prefix)"
            exit 1
          fi

          echo "Assets in release:"
          echo "$RELEASE_JSON" | jq -r '.assets[].name'

          # Find matching asset
          ASSET_ID=""
          for name in $CANDIDATES; do
            ASSET_ID=$(echo "$RELEASE_JSON" | jq -r ".assets[] | select(.name==\"$name\") | .id" | head -1)
            if [ -n "$ASSET_ID" ] && [ "$ASSET_ID" != "null" ]; then
              ASSET_NAME="$name"
              break
            fi
          done

          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" = "null" ]; then
            echo "Error: none of candidate asset names found: $CANDIDATES"
            exit 1
          fi

          echo "Selected asset: $ASSET_NAME (id $ASSET_ID)"
          DOWNLOAD_URL="https://api.github.com/repos/a2hop/rdp-cat/releases/assets/${ASSET_ID}"
          echo "Downloading via asset API: $DOWNLOAD_URL"
          
          curl -L -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/octet-stream" \
            -o rdp-cat "$DOWNLOAD_URL"

          # Basic validation
          if [ ! -s rdp-cat ]; then
            echo "Error: downloaded file empty"
            ls -l rdp-cat
            exit 1
          fi
          
          if file rdp-cat | grep -qi 'text\|html'; then
            echo "Error: downloaded asset is not a binary"
            head -20 rdp-cat
            exit 1
          fi
          
          chmod 755 rdp-cat
          echo "rdp-cat binary downloaded successfully"

          # Move to package
          mkdir -p pkg/usr/local/bin
          cp rdp-cat pkg/usr/local/bin/
          echo "RDP-Cat binary installed successfully"

          # Show binary info
          ls -lh pkg/usr/local/bin/rdp-cat
          file pkg/usr/local/bin/rdp-cat

      - name: Set script permissions
        run: |
          # Set permissions for maintainer scripts (DEBIAN control files)
          chmod 755 pkg/DEBIAN/postinst
          chmod 755 pkg/DEBIAN/prerm
          chmod 755 pkg/DEBIAN/postrm
          
          # Set permissions for control file
          chmod 644 pkg/DEBIAN/control
          
          echo "All permissions set correctly"
          ls -la pkg/DEBIAN/

      - name: Create Debian package
        env:
          DEB_VERSION: ${{ steps.version.outputs.deb_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          # Set architecture in control file
          sed -i "s/Architecture: .*/Architecture: ${ARCH}/" pkg/DEBIAN/control

          # Remove .gitkeep files from package
          echo "Removing .gitkeep files..."
          find pkg -name '.gitkeep' -delete

          # Create the .deb package
          dpkg-deb --build pkg picx--rdpcat_${DEB_VERSION}_${ARCH}.deb

          # Verify package
          if [ ! -f "picx--rdpcat_${DEB_VERSION}_${ARCH}.deb" ]; then
            echo "Failed to create Debian package"
            exit 1
          fi

          # Show package info
          echo "Package created successfully"
          ls -lh picx--rdpcat_${DEB_VERSION}_${ARCH}.deb
          dpkg -I picx--rdpcat_${DEB_VERSION}_${ARCH}.deb

      - name: Test package contents
        env:
          DEB_VERSION: ${{ steps.version.outputs.deb_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          echo "=== Package Contents ==="
          dpkg -c picx--rdpcat_${DEB_VERSION}_${ARCH}.deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rdp-cat-${{ matrix.arch }}
          path: picx--rdpcat_*.deb
          retention-days: 7

  release:
    needs: build
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read package version
        id: version
        run: |
          source deb_version
          echo "deb_version=${DEB}" >> $GITHUB_OUTPUT
          echo "bin_version=${BIN}" >> $GITHUB_OUTPUT
          echo "Package version: ${DEB}"
          echo "Binary version: ${BIN}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize artifacts
        run: |
          mkdir -p release
          find artifacts -name "picx--rdpcat_*.deb" -exec cp {} release/ \;
          cd release
          ls -lh
          echo "=== Artifacts Ready for Release ==="
          sha256sum picx--rdpcat_*.deb > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.version.outputs.deb_version }}
          name: RDP-Cat v${{ steps.version.outputs.deb_version }}
          body: |
            Debian package for RDP-Cat
          artifacts: release/picx--rdpcat_*.deb,release/SHA256SUMS
          draft: false
          prerelease: false

      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo ""
          echo "Package Version: ${{ steps.version.outputs.deb_version }}"
          echo "Binary Version: ${{ steps.version.outputs.bin_version }}"
          echo ""
          echo "Artifacts:"
          ls -lh release/picx--rdpcat_*.deb
          echo ""
          echo "Checksums:"
          cat release/SHA256SUMS
